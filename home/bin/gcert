#!/bin/bash

GIT_AUTO_SYNC=$(which git-auto-sync-all.sh)

# Find the real gcert, not this script.
THIS_SCRIPT="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)/$(basename "${BASH_SOURCE[0]}")"
GCERT=$(which -a gcert | egrep -v -e "^${BASH_SOURCE[0]}" | egrep -v -e "^${THIS_SCRIPT}" | head -n 1)

function LOG() {
  local level="$1"
  shift
  local msg="$*"
  echo "[ ${level} ] ${msg}" >&2
  [[ "${level}" == "FATAL" ]] && exit 1
}

[[ -x "${GCERT}" ]] || LOG FATAL "No 'gcert' binary found!"

${GCERT} "$@"

if [[ -x "${GIT_AUTO_SYNC}" ]]; then
  LOG INFO "Proactively sync'ing all the repositories."
  ${GIT_AUTO_SYNC}
else
  LOG WARNING "Could not find git-auto-sync (skipping)"
fi
